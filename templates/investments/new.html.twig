{% extends 'base.html.twig' %}

{% block title %}New Investments{% endblock %}

{% block body %}
    <h1 style="color: red">New Investments</h1>

    {{ include('investments/_form.html.twig') }}

    <a class="btn btn-outline-info btn-sm mt-2 " href="{{ path('investments_index',{'grouping':'All'}) }}">Return to list</a>
    <br>

{% endblock %}
{% block additionaljs %}
    <script>
        $("input.datetime").flatpickr({
            altInput: true,
            altFormat: "d-m-Y",
            time_24hr: true,
            enableTime: false,
            noCalendar: false,
            dateFormat: "Y-m-d H:i:s",
            minuteIncrement: 15
        });
    </script>


    <script>
        var investmentAmount = $("#investments_investmentAmount").val();
        var numberOfShares = $("#investments_numberOfShares").val();
        var purchaseSharePrice = '';
        purchaseSharePrice = parseFloat(investmentAmount) / parseFloat(numberOfShares);
        $("#investments_purchaseSharePrice").val(purchaseSharePrice);
        $("#investments_investmentAmount").change(function () {
            var investmentAmount = $("#investments_investmentAmount").val();
            var numberOfShares = $("#investments_numberOfShares").val();
            var purchaseSharePrice = '';
            purchaseSharePrice = parseFloat(investmentAmount) / parseFloat(numberOfShares);
            $("#investments_purchaseSharePrice").val(purchaseSharePrice);
            var currency = $("#investments_currency option:selected").text();
            if (currency == 'GBP') {
                $('#investments_initialInvestmentAmountGBP').val(investmentAmount);
            }
        });

        $("#investments_numberOfShares").change(function () {
            var investmentAmount = $("#investments_investmentAmount").val();
            var numberOfShares = $("#investments_numberOfShares").val();
            var purchaseSharePrice = '';
            purchaseSharePrice = parseFloat(investmentAmount) / parseFloat(numberOfShares);
            $("#investments_purchaseSharePrice").val(purchaseSharePrice);
        });

        var currency = $("#investments_currency option:selected").text();
        if (currency == 'GBP') {
            var investmentAmount = $("#investments_investmentAmount").val();
            $('#investments_initialInvestmentAmountGBP').val(investmentAmount);
        }

        $("#investments_currency").change(function () {
            var selectedCurrency = $("#investments_currency option:selected").text();
            if (selectedCurrency == 'GBP') {
                var investmentAmount = $("#investments_investmentAmount").val();
                $('#investments_initialInvestmentAmountGBP').val(investmentAmount);
            }
        });
    </script>

    <script>
        $("#investments_investmentDate").change(function () {
            var date = $("#investments_investmentDate").val();
            var date = date.split("-");
            var year = parseInt(date[0]);
            var month = parseInt(date[1]);
            var day = parseInt(date[2]);
            var yearRange = '';
            var lookBack = '';
            if (month < 4) {
                var previousYear = year - 1;
                var previousYearLookback = previousYear - 1;
                yearRange = previousYear + "-" + year;
                lookBack = previousYearLookback + "-" + previousYear;
                $("#investments_EISPurchaseYear1").val(yearRange).change();
                $("#investments_EISPurchaseYear2").val(lookBack).change();

            } else if (month == 4) {
                if (day < 5) {
                    var previousYear = year - 1;
                    var previousYearLookback = previousYear - 1;
                    yearRange = previousYear + "-" + year;
                    lookBack = previousYearLookback + "-" + previousYear;
                    $("#investments_EISPurchaseYear1").val(yearRange).change();
                    $("#investments_EISPurchaseYear2").val(lookBack).change();
                } else {
                    yearRange = "" + year + "-" + (year + 1);
                    var previousYear = year - 1;
                    lookBack = previousYear + "-" + year;
                    $("#investments_EISPurchaseYear1").val(yearRange).change();
                    $("#investments_EISPurchaseYear2").val(lookBack).change();
                }
            } else {
                yearRange = "" + year + "-" + (year + 1);
                var previousYear = year - 1;
                lookBack = previousYear + "-" + year;
                $("#investments_EISPurchaseYear1").val(yearRange).change();
                $("#investments_EISPurchaseYear2").val(lookBack).change();
            }
        })
    </script>

    <script>
        $("#investments_investmentSaleDate").change(function () {
            var date = $("#investments_investmentSaleDate").val();
            var date = date.split("-");
            var year = parseInt(date[0]);
            var month = parseInt(date[1]);
            var day = parseInt(date[2]);
            var yearRange = '';
            var lookBack = '';
            if (month < 4) {
                var previousYear = year - 1;
                var previousYearLookback = previousYear - 1;
                yearRange = previousYear + "-" + year;
                lookBack = previousYearLookback + "-" + previousYear;
                $("#investments_eISSaleYear1").val(yearRange).change();
                $("#investments_eISSaleYear2").val(lookBack).change();

            } else if (month == 4) {
                if (day < 5) {
                    var previousYear = year - 1;
                    var previousYearLookback = previousYear - 1;
                    yearRange = previousYear + "-" + year;
                    lookBack = previousYearLookback + "-" + previousYear;
                    $("#investments_eISSaleYear1").val(yearRange).change();
                    $("#investments_eISSaleYear2").val(lookBack).change();
                } else {
                    yearRange = "" + year + "-" + (year + 1);
                    var previousYear = year - 1;
                    lookBack = previousYear + "-" + year;
                    $("#investments_eISSaleYear1").val(yearRange).change();
                    $("#investments_eISSaleYear2").val(lookBack).change();
                }
            } else {
                yearRange = "" + year + "-" + (year + 1);
                var previousYear = year - 1;
                lookBack = previousYear + "-" + year;
                $("#investments_eISSaleYear1").val(yearRange).change();
                $("#investments_eISSaleYear2").val(lookBack).change();
            }
        })
    </script>
    <script>
        {% if investment.eisSaleYear1 is not null and investment.eisSaleYear2 is not null %}
        var investment_eisSaleYear1 =  "{{ investment.eISSaleYear1.taxYearRange }}";
        var investment_eisSaleYear2 =  "{{ investment.eISSaleYear2.taxYearRange }}";
        $("#investments_eISSaleYear1").val(investment_eisSaleYear1).change();
        $("#investments_eISSaleYear2").val(investment_eisSaleYear2).change();
        {% endif %}
    </script>
    <script>
      var company =  $("#investments_investmentCompany option:selected").val();
      var url = '/admin/investments/ajax/company/assetclass/'+company;
      $.get(url, function(data, status){
          if(data.tax == 0){
              $('.asset_class_dependent_tax').hide();
          }
          else{
              $('.asset_class_dependent_tax').show();
          }
          if(data.docs==0){
              $('.asset_class_dependent_docs').hide();
          }
          else{
              $('.asset_class_dependent_docs').show();
          }
      });
      $("#investments_investmentCompany").change(function (){
          var company =  $("#investments_investmentCompany option:selected").val();
          var url = '/admin/investments/ajax/company/assetclass/'+company;
          $.get(url, function(data, status){

              if(data.tax == 0){
                  $('.asset_class_dependent_tax').hide();
              }
              else{
                  $('.asset_class_dependent_tax').show();
              }
              if(data.docs==0){
                  $('.asset_class_dependent_docs').hide();
              }
              else{
                  $('.asset_class_dependent_docs').show();
              }
          });
      });

      {# var company = parseInt(company);#}
     {#var test = "{{ Investment.assetClass(2) }}".replace(2,company);#}
     {#alert(test);#}
    </script>
{% endblock additionaljs %}