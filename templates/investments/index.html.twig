{% extends 'base.html.twig' %}

{% block title %}Investments{% endblock %}

{% block body %}

    <h1 style="color: red">Investments
        <a target="_blank" href="{{ path('market_data_index') }}"><i class="fas fa-chart-line"></i></a>
        <a target="_blank" href="{{ path('fx_rates_index') }}"><i class="fas fa-euro-sign"></i></a>
    </h1>

    <table class="table">
        <thead>
        <tr>
            <th>Asset Class</th>
            <th>Investment</th>
            <th style="text-align: right">Investment Date</th>

            <th>EIS</th>
            <th style="text-align: right">Ccy</th>
            <th style="text-align: center;border-right:1px solid black">£ invested</th>

            <th style="text-align: right; background-color: lightcyan">EIS Year</th>
            <th style="text-align: right; background-color: lightcyan">EIS Year £</th>
            <th style="text-align: right; background-color: lightcyan">EIS Year LookBack</th>
            <th style="text-align: right; background-color: lightcyan; border-right:1px solid black">EIS Year LookBack
                £
            </th>

            <th style="text-align: right">MTM (£)</th>
            <th style="text-align: right;border-right:1px solid black">PnL</th>


            <th style="text-align: right;border-right:1px gray">Sale Date</th>
            <th style="text-align: right">EIS Year1</th>
            <th style="text-align: right">EIS Year1 £</th>
            <th style="text-align: right">EIS Year LookBack</th>
            <th style="text-align: right;border-right:1px solid black">EIS Year LookBack £</th>
            <th style="text-align: right;border-right:1px solid black">CGT due</th>

            <th>Share Cert</th>
            <th>EIS Cert</th>
            <th>Other Docs</th>
            <th>Further comms</th>
        </tr>
        </thead>
        <tbody>
        {% set MTMTotal = 0 %}
        {% set PnLTotal = 0 %}
        {% set CGTTotal = 0 %}
        {% for investment in investmentsAll %}
            {% set currentFXRate = 0 %}
            {% for fxRate in fxRates %}
                {% if investment.currency.fx == fxRate.fx %}
                    {% set currentFXRate = fxRate.currentFxRate %}
                {% endif %}
            {% endfor %}
            {% set investmentChildID = 'investment'~investment.id %}
            <tr>


                <td>{{ investment.investmentCompany.assetClass }}</td>

                <td>
                    {% if Investment.findFutureComms(investment.id) == 1 %}
                        <button class="toggle-investment-child btn btn-outline-warning btn-sm"
                                data-investment-child-Id="{{ investmentChildID }}"><i class="fas fa-caret-down"></i>
                        </button>
                    {% endif %}
                    {% if investment.investmentCompany is not null %}
                        <a target="_blank"
                           href="{{ path('investments_edit', {'id': investment.id}) }}">{{ investment.investmentCompany.shareCompany }}</a>
                    {% else %}
                        <a target="_blank" href="{{ path('investments_edit', {'id': investment.id}) }}">--</a>
                    {% endif %}
                </td>

                <td data-sort="{{ investment.investmentDate|date('Y-m-d') }}">{{ investment.investmentDate ? investment.investmentDate|date('d-M-Y') : '' }}</td>

                <!-- Is EIS, SEIS, VCT etc -->
                <td style="text-align: center">
                    {% if investment.taxScheme is not null %}
                        {{ investment.taxScheme.name }}
                    {% endif %}
                </td>

                <!-- Currency -->
                <td>{{ investment.currency.fx }}</td>

                <td style="text-align: right;border-right:1px solid black">
                    {% if investment.currency.fx == 'GBP' %}
                        {{ (investment.numberOfShares*investment.purchaseSharePrice)| number_format (0, '.') }}
                    {% else %}
                        <a title="{{ investment.currency.fx }} {{ (investment.numberOfShares*investment.purchaseSharePrice)| number_format (0, '.') }} ">
                            *{{ (investment.initialInvestmentAmountGBP)| number_format (0, '.') }}</a>
                    {% endif %}
                </td>

                <!-- EIS Years (Purchase) -->
                <td style="text-align: right">
                    {% if investment.EISPurchaseYear1 is not null %}
                        {{ investment.EISPurchaseYear1.taxYearRange }}
                    {% endif %}
                </td>
                <td style="text-align: right">{{ (investment.eISPurchaseYear1Percentage * investment.numberOfShares*investment.purchaseSharePrice /100)|number_format(0,'.') }}</td>
                <td style="text-align: right">
                    {% if investment.EISPurchaseYear2 is not null %}
                        {{ investment.EISPurchaseYear2.taxYearRange }}
                    {% endif %}
                </td>
                <td style="text-align: right;border-right:1px solid black">{{ (investment.eISPurchaseYear2Percentage * investment.numberOfShares*investment.purchaseSharePrice /100)|number_format(0,'.') }}</td>

                <!-- MTM (£) -->
                <td style="text-align: right">
                    {% if investment.currency.fx == 'GBP' %}
                        <a title="{{ investment.investmentCompany.sharePrice | number_format (2, '.') }}"</a> {{ (investment.numberOfShares*investment.investmentCompany.sharePrice)| number_format (0, '.') }}

                        {% set MTMAdd = (investment.numberOfShares*investment.investmentCompany.sharePrice) %}
                        {% set MTMTotal = MTMTotal + MTMAdd %}
                    {% else %}
                        <a title="{{ investment.currency.fx }} {{ (investment.numberOfShares*investment.investmentCompany.sharePrice)| number_format (0, '.') }} ">
                            {{ (investment.numberOfShares*investment.investmentCompany.sharePrice*currentFXRate )| number_format (0, '.') }} </a>
                        {% set MTMAdd = (investment.numberOfShares*investment.investmentCompany.sharePrice*currentFXRate) %}
                        {% set MTMTotal = MTMTotal + MTMAdd %}
                    {% endif %}
                </td>

                <!-- PnL (£) -->
                <td style="text-align: right;border-right:1px solid black">
                    {% if investment.currency.fx == 'GBP' %}
                        {{ ( (investment.numberOfShares*investment.investmentCompany.sharePrice) - (investment.numberOfShares*investment.purchaseSharePrice))  | number_format (0, '.') }}

                        {% set PnLAdd = ((investment.numberOfShares*investment.investmentCompany.sharePrice) - (investment.numberOfShares*investment.purchaseSharePrice)) %}
                        {% set PnLTotal = PnLTotal + PnLAdd %}
                    {% else %}
                        <a title="{{ investment.currency.fx }} {{ (investment.numberOfShares*investment.investmentCompany.sharePrice)| number_format (0, '.') }} ">
                            {{ (investment.numberOfShares*investment.investmentCompany.sharePrice*currentFXRate )| number_format (0, '.') }} </a>
                        {% set PnLAdd =  ((investment.numberOfShares*investment.investmentCompany.sharePrice*currentFXRate) - (investment.numberOfShares*investment.purchaseSharePrice*currentFXRate)) %}
                        {% set PnLTotal = PnLTotal + PnLAdd %}
                    {% endif %}
                </td>


                <!-- Sale Date -->
                <td style="text-align: right;border-right:1px gray"
                    data-sort="{{ investment.currency.fx }}{{ investment.investmentSaleDate|date('Y-m-d') }}">{{ investment.investmentSaleDate ? investment.investmentSaleDate|date('d-M-Y') : '' }}</td>

                <!-- EIS Years (Sale) -->
                <td style="text-align: right">
                    {% if investment.EISSaleYear1 is not null %}
                        {{ investment.EISSaleYear1.taxYearRange }}
                    {% endif %}
                </td>
                <td style="text-align: right">0</td>
                <td style="text-align: right">
                    {% if investment.EISSaleYear2 is not null %}
                        {{ investment.EISSaleYear2.taxYearRange }}
                    {% endif %}
                </td>
                <td style="text-align: right;border-right:1px solid black">0</td>


                <!-- CGT (£) -->
                <td style="text-align: right;border-right:1px solid black">

{#                    {% if investment.currency.fx == 'GBP' %}#}
{#                        {% if investment.taxScheme.name is not null %}#}
{#                            {% if investment.taxScheme.name == 'EIS' %}#}


{#                                {{ ( (investment.numberOfShares*investment.investmentCompany.sharePrice) - (investment.numberOfShares*investment.purchaseSharePrice)) * 0.2 | number_format (0, '.') }}#}
{#                            {% else %}#}
{#                                11#}
{#                            {% endif %}#}
{#                        {% else %}#}
{#                            <a title="{{ investment.currency.fx }} {{ (investment.numberOfShares*investment.investmentCompany.sharePrice)| number_format (0, '.') }} ">#}
{#                                {{ ((investment.numberOfShares*investment.investmentCompany.sharePrice*currentFXRate ) - (investment.numberOfShares*investment.purchaseSharePrice*currentFXRate)) *0.2 | number_format (0, '.') }} </a>#}
{#                            {% set CGTAdd =  ((investment.numberOfShares*investment.investmentCompany.sharePrice*currentFXRate) - (investment.numberOfShares*investment.purchaseSharePrice*currentFXRate))*0.2 %}#}
{#                            {% set CGTTotal = CGTTotal + CGTAdd %}#}
{#                        {% endif %}#}
{#                    {% endif %}#}
                </td>

                <!-- Share cert and other docs -->
                <td style="text-align: center">
                    {% if investment.shareCert is not empty %}
                        <a title="{{ investment.shareCert }}" target="_blank"
                           href="{{ path('investment_viewfile',{ id:investment.id, filetype:'shareCert' }) }}"><i
                                    class="fa fa-paperclip"></i></a>
                    {% endif %}
                </td>
                <td style="text-align: center">
                    {% if investment.eisCert is not empty %}
                        <a title="{{ investment.eisCert }}" target="_blank"
                           href="{{ path('investment_viewfile',{ id:investment.id, filetype:'eisCert' }) }}"><i
                                    class="fa fa-paperclip"></i></a>
                    {% endif %}
                </td>
                <td style="text-align: center">
                    {% if investment.otherDocs is not empty %}
                        <a title="{{ investment.otherDocs }}" target="_blank"
                           href="{{ path('investment_viewfile',{ id:investment.id, filetype:'otherDocs' }) }}"><i
                                    class="fa fa-paperclip"></i></a>
                    {% endif %}
                </td>


                <td style="text-align: center">
                    <a class="btn btn-success btn-sm mt-2"
                       href="{{ path('investment_future_comms_new', {'id': investment.investmentCompany.id}) }}">+</a>
                </td>
            </tr>

            <div id="{{ investmentChildID }}" class="investmentsChildren">

                {#                <td colspan="12"> #}
                <div>
                    {% for investmentFutureComms in investmentsFutureComms %}
                        {% if investmentFutureComms.marketData.id == investment.investmentCompany.id %}
                            <div>
                                <div class="d-flex">
                                    <div><a target="_blank"
                                            href="{{ path('investment_future_comms_edit', {'id': investmentFutureComms.id}) }}"> {{ investmentFutureComms.date |date('d-M-Y') }}</a>
                                    </div>
                                    <div class="mx-2">
                                        {% if investmentFutureComms.attachment is not empty %}
                                            {% for attachment in investmentFutureComms.attachment %}
                                                <a title="{{ attachment }}" target="_blank"
                                                   href="{{ path('investment_future_comms_edit',{id : investmentFutureComms.id}) }}"><i
                                                            class="fa fa-paperclip"></i></a>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    <div class="mx-2">{{ investmentFutureComms.comment }}</div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
        </tbody>
    </table>
    <b> Total MTM (£): </b> {{ MTMTotal | number_format (0, '.') }}<br>
    <b> Total PnL (£): </b> {{ PnLTotal | number_format (0, '.') }}<br>
    <b> Total CGT (£): </b> {{ CGTTotal | number_format (0, '.') }}<br>
    <br>
    <hr>


    <a class="btn btn-success btn-sm mt-2" href="{{ path('investments_new') }}">New Investment</a>
    <br>

{% endblock %}


{% block additionaljs %}
    <script>
        $(".investmentsChildren").hide();
        $('.toggle-investment-child').click(function () {
            var investment_Child_ID = $(this).attr("data-investment-Child-Id");
            $("#" + investment_Child_ID).toggle();
        })
    </script>
{% endblock additionaljs %}


{% block datatable %}
    <script>
        $(document).ready(function () {
            $('.table').DataTable({
                'pageLength': 50,
                "order": [[0, 'asc'], [1, 'asc'], [2, 'asc'], [3, 'asc']],
                "paging": false,
                "searching": true,
                "bInfo": true
            });
        });
    </script>
{% endblock datatable %}