{% extends 'base.html.twig' %}

{% block title %}House Guests Calendar{% endblock %}

{% block body %}
    <h1 style="color: red">House Guests Calendar</h1>
    {% if is_granted('ROLE_ADMIN') %}
        <div class="row">
            <div class="col-3">
                <a class="btn btn-outline-secondary btn-sm"
                   href="{{ path('house_guests_flight_price_scrape_all') }}">Scrape</a>
                <a target="_blank" class="btn btn-outline-primary btn-sm"
                   href="https://www.hermesairports.com/flight-info/arrivals-and-departures-pfo">PFO Arrivals</a>
                <a target="_blank" class="btn btn-outline-primary btn-sm"
                   href="https://www.hermesairports.com/flight-info/arrivals-and-departures-lca">LCA Arrivals</a>
            </div>
            <div class="col-3"></div>
            <div class="col-3">
                <a class="btn btn-danger btn-sm" href="{{ path('flight_stats_delete_all') }}">Delete</a>

                <a class="btn btn-outline-danger btn-sm" target="_blank"
                   href="{{ path('settings_edit', {id: '1'}) }}">Date Range</a>

                <a class="btn btn-outline-secondary btn-sm" target="_blank"
                   href="{{ path('flight_destinations_index') }}">Destinations</a>
            </div>
        </div>
    {% endif %}

    <i title="Scrape range:- Start date: {{ settings.flightStatsStartDate|date('d-M-Y') }}, for {{ settings.flightStatsDays }} days"
       class="fa fa-info-circle"></i>

    <table class="table table-responsive">
        <thead>
        <tr>
            <th>Date</th>
            <th>Book</th>
            <th>Travel Notes</th>
            <th style="border-right: 1px dotted grey; border-right: 1px solid grey">
                Notes
            </th>
            {% if is_granted('ROLE_ADMIN') %}
                <th>
                    Delete
                </th>
            {% endif %}


            {% for flight_destination in flight_destinations %}

                {% if is_granted('ROLE_ADMIN') or flight_destination.adminOnly==0 %}
                    {% if flight_destination.id is even %}
                        <th style="border-right: 1px dotted grey; background-color: lightgrey">
                    {% else %}
                        <th style="background-color: lightgrey">
                    {% endif %}
                    {{ flight_destination.departureCode }} - <br>{{ flight_destination.arrivalCode }}
                    {% if flight_destination.adminOnly==1 %}
                        <i style="color: green" class="fa fa-hat-wizard"></i>
                        {% endif %}
                {% endif %}
                </th>
            {% endfor %}


        </tr>
        </thead>
        <tbody>
        {% for date in dates %}
            {% set id = '' %}
            {% if date|date('D') == "Sat" or date|date('D') == "Sun" %}
                <tr style="background-color: #bac8f3">
            {% else %}
                <tr>
            {% endif %}

            <td data-sort={{ date| date('Y-m-d') }}>{{ date | date('D d-M-Y') }}</td>
            <td>
                {% set flag = 0 %}
                {% for house_guest in house_guests %}
                    {% if house_guest['date'] == date|date('d-m-y') %}
                        {% if is_granted('ROLE_ADMIN') or app.user.id ==house_guest['guest'].id %}
                            <a target="_blank"
                               href="{{ path('house_guests_edit', {'id':house_guest['id'] }) }}">{{ house_guest['guest'].fullName }}</a>
                        {% else %}
                            Booked
                        {% endif %}
                        {% set flag = 1 %}
                        {% set id = house_guest['id'] %}
                    {% endif %}
                {% endfor %}
                {% if flag==0 %}
                    <a target="_blank" class="btn btn-success btn-sm"
                       href="{{ path('house_guests_new', {'startdate': date|date('d-m-Y')}) }}">Book</a>
                {% endif %}
            </td>


            <td>
                {% for house_guest in house_guests %}
                    {% if is_granted('ROLE_ADMIN') or app.user.id ==house_guest['guest'].id %}
                        {% if house_guest['arrivalDate'] == date|date('d-m-y') %}
                            {{ house_guest['arrivalNotes'] |raw }}
                        {% endif %}
                        {% if house_guest['departureDate'] == date|date('d-m-y') %}
                            {{ house_guest['departureNotes'] |raw }}
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </td>

            <td style="border-right: 1px solid grey">
                {% for house_guest in house_guests %}
                    {% if is_granted('ROLE_ADMIN') or app.user.id ==house_guest['guest'].id %}
                        {% if house_guest['arrivalDate'] == date|date('d-m-y') %}
                            {{ house_guest['notes'] |raw }}
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </td>

            {% if is_granted('ROLE_ADMIN') %}
                <td style="border-right: 1px solid grey">
                    {% if id != '' %}
                        <form method="post" action="{{ path('house_guests_delete', {'id':id }) }}"
                              onsubmit="return confirm('Are you sure you want to delete this item?');">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ id) }}">
                            <button class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    {% endif %}
                </td>
            {% endif %}
            {% for flight_destination in flight_destinations %}
                {% if is_granted('ROLE_ADMIN') or flight_destination.adminOnly==0 %}
                    {% if flight_destination.id is even %}
                        <td style="border-right: 1px dotted grey">
                    {% else %}
                        <td>
                    {% endif %}

                    {% for flight in flights %}
                        {% if flight.date == date and flight.flightFrom==flight_destination.departureCode and flight.flightTo ==flight_destination.arrivalCode %}
                            {% set URL = "https://www.kayak.co.uk/flights/"~flight.flightFrom~"-"~ flight.flightTo ~"/"~ date|date('Y-m-d')  ~ "?sort=price_a&fs=stops=0" %}
                            <a target="_blank" href="{{ URL }}">Â£{{ flight.lowestPrice|number_format('0') }}</a>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                </td>
            {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <br>

{% endblock %}

{% block datatable %}
    <script>
        $(document).ready(function () {
            $('.table').DataTable({
                'pageLength': 100,
                "order": [[0, 'asc']],
                "paging": false,
                "searching": false,
                "bInfo": false
            });
        });
    </script>
{% endblock datatable %}
