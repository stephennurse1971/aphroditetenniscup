{% extends 'base.html.twig' %}

{% block title %}House Guests Calendar{% endblock %}

{% block body %}
    <h1 style="color: red">House Guests Calendar</h1>

    {% include 'house_guests/parts/house_guest_buttons.html.twig' %}

    <table class="table table-responsive" style="width: 100%">
        <thead>
        <tr>
            <th>Date</th>
            <th>Book</th>
            <th>Travel Notes</th>
            <th style="border-right: 1px solid grey">
                Notes
            </th>
            {% if is_granted('ROLE_ADMIN') %}
                <th style="border-right: 1px solid grey">
                    Delete
                </th>
            {% endif %}
            {% include 'house_guests/parts/house_guest_flight_prices_headers.html.twig' %}
        </tr>

        <tr>
            <th class="desktop"></th>
            <th class="desktop"></th>
            <th class="desktop"></th>
            <th class="desktop" style="border-right: 1px solid grey"></th>
            {% if is_granted('ROLE_ADMIN') %}
                <th style="border-right: 1px solid grey"> </th>
            {% endif %}
            {% include 'house_guests/parts/house_guest_flight_prices_headers2.html.twig' %}
        </tr>

        </thead>

        <tbody>
        {% for date in dates %}
            {% set id = '' %}
            <tr>
                {% if date|date('D') == "Sat" or date|date('D') == "Sun" %}
                    <td style="background-color: lightblue" data-sort="{{ date| date('Y-m-d') }}">
                        {{ date | date('D d-M-y') }}
                    </td>
                {% else %}
                    <td data-sort="{{ date| date('Y-m-d') }}">
                        {{ date | date('D d-M-y') }}
                    </td>
                {% endif %}

                <td style="background-color: white">
                    {% set flag = 0 %}
                    {% for house_guest in house_guests %}
                        {% if house_guest['date'] == date|date('d-m-y') %}

                            {% if house_guest['referenceInformation'] == "Internal Note" %}
                                {% set flag = 1 %}
                                {% if is_granted('ROLE_ADMIN') %}
                                    <a target="_blank"
                                       href="{{ path('house_guests_edit', {'id':house_guest['id'] }) }}">Internal
                                        Note</a>
                                {% endif %}
                            {% elseif house_guest['referenceInformation'] == "Block-Out" %}
                                {% set flag = 1 %}
                                {% if is_granted('ROLE_ADMIN') %}
                                    <a target="_blank"
                                       href="{{ path('house_guests_edit', {'id':house_guest['id'] }) }}">Block-Out</a>
                                {% else %}
                                    N/A
                                {% endif %}
                            {% else %}
                                {% if is_granted('ROLE_ADMIN') or app.user.id ==house_guest['guest'].id %}
                                    {% if house_guest['guest'] is not null %}
                                        <a target="_blank"
                                           href="{{ path('house_guests_edit', {'id':house_guest['id'] }) }}">{{ house_guest['guest'].fullName }}</a>
                                    {% endif %}
                                {% else %}
                                    Booked
                                {% endif %}
                                {% set flag = 1 %}
                                {% set id = house_guest['id'] %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {% if flag==0 %}
                        <a target="_blank" class="btn btn-success btn-sm"
                           href="{{ path('house_guests_new', {'startdate': date|date('d-m-Y')}) }}">Book</a>
                    {% endif %}
                </td>

                <td style="background-color: white">
                    {% for house_guest in house_guests %}
                        {% if house_guest['referenceInformation'] == "Guest Booking" %}
                            {% if is_granted('ROLE_ADMIN') or app.user.id ==house_guest['guest'].id %}
                                {% if house_guest['arrivalDate'] == date|date('d-m-y') %}
                                    {{ house_guest['arrivalNotes'] |raw }}
                                {% endif %}
                                {% if house_guest['departureDate'] == date|date('d-m-y') %}
                                    {{ house_guest['departureNotes'] |raw }}
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </td>

                <td style="border-right: 1px solid grey; background-color: white">
                    {% for house_guest in house_guests %}
                        {% if house_guest['referenceInformation'] == "Guest Booking" %}
                            {% if is_granted('ROLE_ADMIN') or app.user.id ==house_guest['guest'].id %}
                                {% if house_guest['arrivalDate'] == date|date('d-m-y') %}
                                    {{ house_guest['notes'] |raw }}
                                {% endif %}
                            {% endif %}
                        {% else %}
                            {% if is_granted('ROLE_ADMIN') and house_guest['arrivalDate'] == date|date('d-m-y') %}
                                {{ house_guest['notes'] |raw }}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </td>

                {% if is_granted('ROLE_ADMIN') %}
                    <td style="border-right: 1px solid grey; background-color: white">
                        {% if id != '' %}
                            <form method="post" action="{{ path('house_guests_delete', {'id':id }) }}"
                                  onsubmit="return confirm('Are you sure you want to delete this item?');">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ id) }}">
                                <button class="btn btn-danger btn-sm">Delete</button>
                            </form>
                        {% endif %}
                    </td>
                {% endif %}
                {% include 'house_guests/parts/house_guest_flight_prices.html.twig' %}
            </tr>
        {% endfor %}

        </tbody>
    </table>
    <br>

{% endblock %}

{% block datatable %}
    <script>
        $(document).ready(function () {
            $('.table').DataTable({
                'pageLength': 100,
                // "ordering": [[0, 'asc']],
                'ordering': false,
                "paging": false,
                "searching": false,
                "bInfo": false
            });
        });
    </script>
{% endblock datatable %}
